# üóÑÔ∏è Cassandra Connection System - H∆∞·ªõng D·∫´n Chi Ti·∫øt

## üìã T·ªïng Quan

H·ªá th·ªëng k·∫øt n·ªëi Apache Cassandra ƒë√£ ƒë∆∞·ª£c refactor ƒë·ªÉ t·∫≠p trung h√≥a v√† chu·∫©n h√≥a vi·ªác qu·∫£n l√Ω database connections trong distributed system. T·∫•t c·∫£ c√°c microservices ƒë·ªÅu s·ª≠ d·ª•ng chung m·ªôt connection utility ƒë·ªÉ ƒë·∫£m b·∫£o consistency v√† d·ªÖ maintain.

## üèóÔ∏è Ki·∫øn Tr√∫c M·ªõi

### üìÅ C·∫•u Tr√∫c File

```
src/
‚îú‚îÄ‚îÄ database/
‚îÇ   ‚îî‚îÄ‚îÄ cassandraConnection.js     # Centralized connection utility
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ userService.js            # User microservice (refactored)
‚îÇ   ‚îú‚îÄ‚îÄ orderService.js           # Order microservice (refactored)
‚îÇ   ‚îî‚îÄ‚îÄ apiGateway.js             # API Gateway (enhanced)
```

### üîó Connection Flow

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   User Service  ‚îÇ    ‚îÇ  Order Service  ‚îÇ    ‚îÇ   API Gateway   ‚îÇ
‚îÇ    Port 3001    ‚îÇ    ‚îÇ    Port 3002    ‚îÇ    ‚îÇ    Port 3003    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ                       ‚îÇ                       ‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                 ‚îÇ
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ         cassandraConnection.js                ‚îÇ
         ‚îÇ    - Centralized connection management        ‚îÇ
         ‚îÇ    - Health checks & retry logic              ‚îÇ
         ‚îÇ    - Database initialization                  ‚îÇ
         ‚îÇ    - Query execution helpers                  ‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                 ‚îÇ
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ                       ‚îÇ                       ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Cassandra 1   ‚îÇ    ‚îÇ   Cassandra 2   ‚îÇ    ‚îÇ   Cassandra 3   ‚îÇ
‚îÇ   Port: 9042    ‚îÇ    ‚îÇ   Port: 9043    ‚îÇ    ‚îÇ   Port: 9044    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üìã Chi Ti·∫øt T·ª´ng Component

### üîß 1. cassandraConnection.js - Core Utility

**M·ª•c ƒë√≠ch:** Centralized connection management cho t·∫•t c·∫£ Cassandra operations

**Ch·ª©c nƒÉng ch√≠nh:**
```javascript
// Connection Configuration
const client = new Client({
    contactPoints: ['cassandra1', 'cassandra2', 'cassandra3'],  // 3-node cluster
    localDataCenter: 'datacenter1',                            // DC routing
    protocolOptions: { port: 9042 },                          // Default port
    policies: { retry: { retryDelay: 1000, maxRetryCount: 3 }} // Retry policy
});

// Health Check Functions
- checkCassandraHealth()      // Ki·ªÉm tra cluster health
- waitForCassandraReady()     // ƒê·ª£i cluster s·∫µn s√†ng v·ªõi retry

// Database Initialization
- createKeyspace()            // T·∫°o keyspace v·ªõi RF=3
- useKeyspace()              // Switch t·ªõi keyspace
- createUsersTable()         // T·∫°o users table
- createOrdersTable()        // T·∫°o orders table
- initializeDatabase()       // Main initialization function

// Query Helpers
- executeQuery()             // Safe prepared statement execution
- closeConnection()          // Graceful shutdown
```

**Schema Management:**
```sql
-- Keyspace with Replication Factor = 3
CREATE KEYSPACE IF NOT EXISTS test_keyspace
WITH replication = {
    'class': 'SimpleStrategy', 
    'replication_factor': 3
};

-- Users Table
CREATE TABLE IF NOT EXISTS users (
    id text PRIMARY KEY,
    name text,
    email text,
    created_at timestamp,
    updated_at timestamp
);

-- Orders Table  
CREATE TABLE IF NOT EXISTS orders (
    id text PRIMARY KEY,
    user_id text,
    items text,                -- JSON serialized
    total_amount decimal,
    status text,
    created_at timestamp,
    updated_at timestamp
);
```

### üë§ 2. userService.js - User Microservice

**Port:** 3001  
**Endpoints:**
- `GET /health` - Service health check
- `GET /users` - L·∫•y danh s√°ch users
- `GET /users/:id` - L·∫•y user theo ID
- `POST /users` - T·∫°o user m·ªõi
- `PUT /users/:id` - C·∫≠p nh·∫≠t user
- `DELETE /users/:id` - X√≥a user

**Key Features:**
```javascript
// Import centralized connection
const { 
    initializeDatabase, 
    executeQuery, 
    checkCassandraHealth,
    closeConnection 
} = require('../database/cassandraConnection');

// Auto-initialization on startup
app.listen(port, async () => {
    await initializeDatabase();
    console.log('‚úÖ USER SERVICE STARTED SUCCESSFULLY!');
});

// Prepared statements for security
const query = 'INSERT INTO users (id, name, email, created_at, updated_at) VALUES (?, ?, ?, ?, ?)';
await executeQuery(query, [id, name, email, created_at, created_at]);

// Graceful shutdown
process.on('SIGINT', async () => {
    await closeConnection();
    process.exit(0);
});
```

### üõí 3. orderService.js - Order Microservice

**Port:** 3002  
**Endpoints:**
- `GET /health` - Service health check
- `GET /orders` - L·∫•y danh s√°ch orders
- `GET /orders/:id` - L·∫•y order theo ID
- `GET /orders/user/:userId` - L·∫•y orders theo user
- `POST /orders` - T·∫°o order m·ªõi
- `PUT /orders/:id` - C·∫≠p nh·∫≠t order
- `DELETE /orders/:id` - X√≥a order

**Business Logic:**
```javascript
// JSON serialization cho complex data
const params = [
    id, 
    userId, 
    JSON.stringify(items),  // Serialize array to JSON string
    totalAmount, 
    status,
    created_at, 
    created_at
];

// Data transformation khi retrieve
const orders = result.rows.map(row => ({
    id: row.id,
    userId: row.user_id,
    items: JSON.parse(row.items),  // Parse JSON back to array
    totalAmount: parseFloat(row.total_amount),
    status: row.status || 'pending'
}));

// Status validation
const validStatuses = ['pending', 'processing', 'completed', 'cancelled'];
```

### üåê 4. apiGateway.js - API Gateway

**Port:** 3003  
**Ch·ª©c nƒÉng:** Entry point cho distributed system

**Monitoring Endpoints:**
- `GET /health` - Gateway health check
- `GET /monitoring` - System-wide monitoring
- `GET /logs` - Web-based log viewer
- `GET /metrics` - Performance metrics

**Proxy Endpoints:**
- `GET /api/users` ‚Üí `user_service:3001/users`
- `POST /api/users` ‚Üí `user_service:3001/users`
- `GET /api/orders` ‚Üí `order_service:3002/orders`
- `POST /api/orders` ‚Üí `order_service:3002/orders`

**Field Mapping:**
```javascript
// External API format ‚Üí Internal Service format
const requestBody = {
    userId: req.body.user_id || req.body.userId,           // Flexible field names
    items: req.body.items,
    totalAmount: req.body.total_amount || req.body.totalAmount
};

// Support multiple formats
const requestBody = {
    name: req.body.username || req.body.name,  // username OR name
    email: req.body.email
};
```

## üöÄ C√°ch S·ª≠ D·ª•ng

### 1. **Kh·ªüi ƒê·ªông H·ªá Th·ªëng**

```bash
# Start all services v·ªõi Docker Compose
docker-compose -f docker-compose.distributed.yml up -d

# Ki·ªÉm tra logs
docker-compose -f docker-compose.distributed.yml logs -f
```

### 2. **Health Checks**

```bash
# Check API Gateway
curl http://localhost:3003/health

# Check User Service
curl http://localhost:3001/health

# Check Order Service  
curl http://localhost:3002/health

# System monitoring
curl http://localhost:3003/monitoring
```

### 3. **CRUD Operations via API Gateway**

```bash
# T·∫°o user m·ªõi
curl -X POST http://localhost:3003/api/users \
  -H "Content-Type: application/json" \
  -d '{"username": "Nguyen Van A", "email": "nguyenvana@example.com"}'

# L·∫•y danh s√°ch users
curl http://localhost:3003/api/users

# T·∫°o order m·ªõi
curl -X POST http://localhost:3003/api/orders \
  -H "Content-Type: application/json" \
  -d '{
    "user_id": "1704067200000",
    "items": [{"name": "Product A", "quantity": 2, "price": 100000}],
    "total_amount": 200000
  }'

# L·∫•y danh s√°ch orders
curl http://localhost:3003/api/orders
```

## üîç Debugging & Monitoring

### 1. **Log Viewing**

```bash
# Web-based log viewer
curl http://localhost:3003/logs?lines=100

# Docker logs
docker logs user_service
docker logs order_service
docker logs api_gateway
```

### 2. **Performance Metrics**

```bash
# System metrics
curl http://localhost:3003/metrics

# Memory usage
docker stats
```

### 3. **Database Verification**

```bash
# Connect to Cassandra
docker exec -it cassandra1 cqlsh

# Check keyspace
DESCRIBE KEYSPACES;
USE test_keyspace;

# Check tables
DESCRIBE TABLES;
SELECT * FROM users LIMIT 10;
SELECT * FROM orders LIMIT 10;
```

## üõ†Ô∏è Troubleshooting

### ‚ùå Common Issues

**1. Services kh√¥ng start:**
```bash
# Check container status
docker-compose -f docker-compose.distributed.yml ps

# Check specific service logs
docker-compose -f docker-compose.distributed.yml logs user_service
```

**2. Cassandra connection timeout:**
```bash
# Wait longer cho cluster initialization
# Default wait time: 60s trong docker-compose

# Manual health check
curl http://localhost:3001/health
```

**3. API Gateway kh√¥ng reach services:**
```bash
# Check Docker network
docker network ls
docker network inspect apache-cassandra_cassandra_net

# Check service names resolution
docker exec api_gateway ping user_service
```

### ‚úÖ Performance Tuning

**Memory Optimization:**
```yaml
# docker-compose.yml
services:
  cassandra1:
    environment:
      - MAX_HEAP_SIZE=2G
      - HEAP_NEWSIZE=400M
```

**Connection Pooling:**
```javascript
// cassandraConnection.js
const client = new Client({
    pooling: {
        heartBeatInterval: 30000,
        maxRequestsPerConnection: 32768
    }
});
```

## üìä Best Practices

### 1. **Error Handling**
```javascript
// Always use try-catch v·ªõi detailed logging
try {
    await executeQuery(query, params);
    console.log('‚úÖ Operation successful');
} catch (error) {
    console.error('‚ùå Operation failed:', error.message);
    throw error;
}
```

### 2. **Prepared Statements**
```javascript
// ‚úÖ GOOD - Use prepared statements
await executeQuery('SELECT * FROM users WHERE id = ?', [userId]);

// ‚ùå BAD - String concatenation (SQL injection risk)
await client.execute(`SELECT * FROM users WHERE id = '${userId}'`);
```

### 3. **Graceful Shutdown**
```javascript
// Handle SIGINT and SIGTERM
process.on('SIGINT', async () => {
    await closeConnection();
    process.exit(0);
});
```

### 4. **Health Monitoring**
```javascript
// Regular health checks
app.get('/health', async (req, res) => {
    const isHealthy = await checkCassandraHealth();
    const statusCode = isHealthy ? 200 : 503;
    res.status(statusCode).json({ status: isHealthy ? 'ok' : 'degraded' });
});
```

## üéØ K·∫øt Lu·∫≠n

H·ªá th·ªëng connection m·ªõi provide:

- ‚úÖ **Centralized Management** - T·∫•t c·∫£ database logic t·∫≠p trung
- ‚úÖ **Better Error Handling** - Consistent error handling across services  
- ‚úÖ **Improved Logging** - Detailed Vietnamese comments v√† logs
- ‚úÖ **Health Monitoring** - Comprehensive health checks
- ‚úÖ **Graceful Shutdown** - Proper resource cleanup
- ‚úÖ **Scalability** - Easy to add new services
- ‚úÖ **Maintainability** - Single source of truth cho DB operations

System gi·ªù ƒë√¢y s·∫µn s√†ng cho production use v·ªõi robust error handling v√† comprehensive monitoring capabilities! üöÄ 